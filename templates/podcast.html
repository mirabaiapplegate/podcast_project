{% extends 'base.html' %}

{% block head %}
    <link rel="stylesheet" type="text/css" href="/static/css/podcast.css">
    <link rel="stylesheet" type="text/css" href="/static/amplitudejs-master/examples/single-song-live/css/styles.css">
{% endblock%}

{% block body %}

    <!-- Podcast Title and Episode -->
    <div class="col-md-12 col-lg-12 col-xs-12">
      <h4>{{ podcast.show }}: {{ podcast.title }}</h4>
      <p>{{ podcast.description }}</p>
      <!-- Start Carousel -->
      <div id="carousel-image" class="carousel slide" data-ride="carousel" data-interval="false">
        <!-- Indicators -->
        <ol class="carousel-indicators"></ol>
        <!-- Wrapper for slides -->
        <div class="carousel-inner">
          <div class="carousel-caption">
          <!-- TODO How to render event.link??!?!?! -->
          </div>
        </div>
        <!-- Controls -->
        <a class="left carousel-control" href="#carousel-image" data-slide="prev">
          <span class="glyphicon glyphicon-chevron-left"></span>
        </a>
        <a class="right carousel-control" href="#carousel-image" data-slide="next">
          <span class="glyphicon glyphicon-chevron-right"></span>
        </a>
      </div>

      <form class="form-inline" action="/addComment" method="post" role="form">
        <div class="form-group">
          <img class="img-responsive img-rounded" src="{{ user.profile_image }}" id="comment-profile-image">
        </div>
        <div class="form-group">
          <label class="sr-only" for="comment"></label>
          <input type="comment" name="comment" class="form-control" id="comment" placeholder="Write a comment">
        </div>

        <button type="submit" class="btn btn-primary" id="submit">Submit</button>
      </form>

      <div class="container">
      <div class="row">
      <div class="col-sm-12">
      <h3>Comments</h3>
      </div><!-- /col-sm-12 -->
      </div><!-- /row -->
      <div id="comment-template">
        <div class="row comment-box">
        <div class="col-sm-1">
        <div class="thumbnail">
        <img class="img-responsive user-photo" src="">
        </div><!-- /thumbnail -->
        </div><!-- /col-sm-1 -->
        <div class="col-sm-5">
          <div class="panel panel-default">
            <div class="panel-heading">
              <strong>TEST</strong> 
            </div>
          <div class="panel-body comment-body">
            THIS IS A COMMENT
          </div><!-- /panel-body -->
          </div><!-- /panel panel-default -->
        </div><!-- /col-sm-5 -->
      </div>
      <div class="comments">
        {% for comment in comments %}
        <div class="row comment-box">
          <div class="col-sm-1">
          <div class="thumbnail">
          <img class="img-responsive user-photo" src="{{ comment.user.profile_image }}">
          </div><!-- /thumbnail -->
          </div><!-- /col-sm-1 -->
          <div class="col-sm-5">
            <div class="panel panel-default">
              <div class="panel-heading">
                <strong>{{ comment.user.first_name }} {{ comment.user.last_name }}</strong> 
              </div>
            <div class="panel-body">
            {{ comment.comment }}
            </div><!-- /panel-body -->
            </div><!-- /panel panel-default -->
          </div><!-- /col-sm-5 -->
        </div><!-- /row -->

        {% endfor %}
      </div>

      </div><!-- /container -->

    </div>
    <!-- End Carousel -->
    {% endblock %}

    {% block footer %}
    <!-- Begin Small Audio Player -->
    <div id="small-player">

      <!-- Begin Small Player Left -->
      <div id="small-player-left">
      </div>
      <!-- End Small Player Left -->

      <!-- Begin Small Player Album Art -->
      <img id="small-player-album-art" amplitude-song-info="cover"/>
      <!-- End Small Player Album Art -->

      <!-- Begin Small Player Middle -->
      <div id="small-player-middle">  
        <div id="small-player-middle-top">

          <!-- Begin Controls Container -->
          <div id="small-player-middle-controls">
            <div class="amplitude-play-pause amplitude-paused" amplitude-main-play-pause="true"></div>
          </div>
          <!-- End Controls Container -->

          <!-- Begin Meta Container -->
          <div id="small-player-middle-meta">
            <div id="now-playing-title" amplitude-song-info="name"></div>
            <div class="album-information" amplitude-song-info="artist"> </div>
            
            <div class="amplitude-song-time-visualization" amplitude-single-song-time-visualization="true" id="song-time-visualization"></div>

          </div>
          <!-- End Meta Container -->
        </div>
      </div>
      <!-- End Small Player Middle -->

      <!-- Begin Small Player Right -->
      <div id="small-player-right">
        <span id="current-time">
          <span class="amplitude-current-minutes" amplitude-single-current-minutes="true">0</span>:<span class="amplitude-current-seconds" amplitude-single-current-seconds="true">00</span>
        </span>
      </div>
      <!-- End Small Player Right -->
    </div>
    <!-- End Small Player -->


    {% endblock %}   

    <!-- Javascript -->
    {% block js %}
      <script src="/static/js/podcast.js"></script>
      <script> 
        "use strict";
        // Wait until page has loaded
        $(document).ready(function() {

        // Get an object of arrays of urls
        $.get('/images/{{ podcast.podcast_id }}.json', function(result) {
          
          $.each(result.data, function(i, image_attrs) {
            $('<div class="item"><img src="'+image_attrs.image_url+'" class="img-responsive center-block"><div class="carousel-caption"></div></div>').appendTo('.carousel-inner');
            
            $('<li data-target="#carousel-image" data-slide-to="'+i+'"></li>').appendTo('.carousel-indicators');
          });

          $('.item').first().addClass('active');
          $('.carousel-indicators > li').first().addClass('active');
          $('#carousel-image').carousel();

          Amplitude.active.addEventListener('timeupdate', function(event) { 
            console.log(event.path[0].currentTime);
            var currentPos = event.path[0].currentTime;
            // if currentPos >= start_at && currentPos <= end_at
            $.each(result.data, function (i, image_attrs) {
              console.log((currentPos >= image_attrs.start_at), (currentPos <= image_attrs.end_at));
              if(currentPos >= image_attrs.start_at && currentPos <= image_attrs.end_at) {
                console.log("Yes!");
                // $('#my-iframe').attr('href', image_attrs.image_url)
                $('#carousel-image').carousel(i);
              }
            });
          });
        });

        // Initialize Amplitude Audio Player
        Amplitude.init({
          "songs": [
              {
                  "name": "{{ podcast.show }}",
                  "artist": "{{ podcast.title }}",
                  "url": "{{ podcast.audio }}",
                  "live": false,
                  "cover_art_url": "{{ podcast.image }}"
              }
          ],
          "default_album_art": "images/no-cover.png"
        });

        
        // Click event handler for comments
        $('#submit').click(function(event) {
          event.preventDefault();

          var comment = $('#comment').val();
          
          $.ajax({
               url: '/addComment',
               data: $('form').serialize(),
               type: 'POST',
               success: function(response) {
                
                console.log(response);
                comment = response.comment;

                var new_comment = $("#comment-template").clone();

                new_comment.find(".comment-body").text(comment);

                $('.comments').prepend(new_comment);

               },
               error: function(error) {
                   console.log(error);
               }
           });

        });

        });
      </script>
    {% endblock %}
